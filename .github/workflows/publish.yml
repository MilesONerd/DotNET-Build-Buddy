name: Build and Publish Extension

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Compile TypeScript
        run: npm run compile

      - name: Install vsce
        run: npm install -g @vscode/vsce

      - name: Install ovsx
        run: npm install -g ovsx

      - name: Extract version from tag
        id: get_version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.release.tag_name }}" != "" ]]; then
            VERSION=${GITHUB_EVENT_RELEASE_TAG_NAME#v}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            VERSION=$(node -p "require('./package.json').version")
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi
          echo "Extracted version: $VERSION"

      - name: Update package.json version
        if: steps.get_version.outputs.version != ''
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          if [[ $(echo $VERSION | grep -o "\." | wc -l) -lt 2 ]]; then
            VERSION="$VERSION.0"
          fi
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          if [ "$CURRENT_VERSION" != "$VERSION" ]; then
            echo "Updating package.json version to $VERSION"
            npm version $VERSION --no-git-tag-version
          else
            echo "Version $VERSION is already set, skipping npm version"
          fi        

      - name: Package extension
        run: vsce package --no-yarn
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: Verify publisher ID
        run: |
          PUBLISHER=$(node -p "require('./package.json').publisher")
          echo "Publisher ID: $PUBLISHER"
          if [ -z "$PUBLISHER" ]; then
            echo "Error: Publisher ID not found in package.json"
            exit 1
          fi

      - name: Create OpenVSX namespace (if not exists)
        run: |
          PUBLISHER=$(node -p "require('./package.json').publisher")
          echo "Attempting to create namespace: $PUBLISHER"
          ovsx create-namespace "$PUBLISHER" -p ${{ secrets.OVSX_PAT }} || echo "Namespace may already exist, continuing..."
        continue-on-error: true
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}

      - name: Publish to VS Code Marketplace
        run: vsce publish --no-yarn -p ${{ secrets.VSCE_PAT }}
        continue-on-error: true
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: Publish to OpenVSX
        run: |
          VSIX_FILE=$(ls *.vsix | head -n 1)
          if [ -z "$VSIX_FILE" ]; then
            echo "Error: No .vsix file found"
            exit 1
          fi
          echo "Publishing $VSIX_FILE to OpenVSX..."
          ovsx publish "$VSIX_FILE" -p ${{ secrets.OVSX_PAT }}
        continue-on-error: true
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-vsix
          path: '*.vsix'
          retention-days: 30